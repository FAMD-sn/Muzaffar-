<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±–ª–∞—á–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }

        .header {
            background: #2d3748;
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #4a5568;
            padding: 8px 15px;
            border-radius: 30px;
        }

        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .device-list {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            font-size: 12px;
        }

        .device-badge {
            background: #edf2f7;
            padding: 3px 8px;
            border-radius: 12px;
            color: #2d3748;
        }

        .toolbar {
            padding: 20px;
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: #4299e1; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-sync { background: #9f7aea; color: white; }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .tables-list {
            padding: 20px;
            background: #edf2f7;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .table-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: white;
            color: #4a5568;
            font-weight: 500;
        }

        .table-btn.active {
            background: #4299e1;
            color: white;
        }

        .table-container {
            padding: 20px;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: #4a5568;
            color: white;
            padding: 12px;
            position: sticky;
            top: 0;
        }

        td {
            border: 1px solid #e2e8f0;
            padding: 10px;
        }

        td[contenteditable="true"]:focus {
            outline: 2px solid #4299e1;
            background: #ebf8ff;
        }

        .action-cell {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .edit-btn { background: #4299e1; color: white; }
        .delete-btn { background: #f56565; color: white; }

        .status-bar {
            background: #e2e8f0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .login-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .login-input {
            padding: 8px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            width: 200px;
        }

        .device-id {
            background: #4a5568;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .share-link {
            background: #ebf8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚òÅÔ∏è –û–±–ª–∞—á–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h1>
            <div class="sync-status">
                <span class="sync-dot"></span>
                <span id="sync-status">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
            </div>
        </div>

        <div style="padding: 15px 20px; background: #4a5568; color: white; display: flex; justify-content: space-between; align-items: center;">
            <div class="login-form">
                <input type="text" class="login-input" id="username" placeholder="–í–∞—à–µ –∏–º—è" value="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
                <button class="btn btn-primary" onclick="setUsername()">üë§ –í–æ–π—Ç–∏</button>
            </div>
            <div class="device-id" id="device-id">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="tables-list" id="tables-list">
            <button class="table-btn active" onclick="switchTable('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="table-btn" onclick="switchTable('products')">üì¶ –¢–æ–≤–∞—Ä—ã</button>
            <button class="table-btn" onclick="switchTable('orders')">üìã –ó–∞–∫–∞–∑—ã</button>
            <button class="table-btn" onclick="addNewTable()">‚ûï –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞</button>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="openAddModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="btn btn-sync" onclick="forceSync()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-success" onclick="shareDatabase()">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            <button class="btn btn-warning" onclick="showHistory()">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
            <input type="text" class="login-input" id="searchInput" 
                   placeholder="üîç –ü–æ–∏—Å–∫..." style="width: 250px;" onkeyup="searchTable()">
        </div>

        <div class="device-list" id="active-devices" style="padding: 10px 20px; background: #edf2f7;">
            <span class="device-badge">üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ–Ω–ª–∞–π–Ω: 1</span>
        </div>

        <div class="table-container">
            <table id="data-table">
                <thead id="table-header"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>

        <div class="status-bar">
            <div>–ó–∞–ø–∏—Å–µ–π: <span id="record-count">0</span></div>
            <div>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö: <span id="last-sync">—Ç–æ–ª—å–∫–æ —á—Ç–æ</span></div>
            <div>üîÑ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h2>
            <form id="data-form" onsubmit="saveRecord(event)">
                <div id="form-fields"></div>
                <div class="modal-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-warning" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ Supabase
        const SUPABASE_URL = 'https://sxkyilpxzobxjdhjvxae.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4a3lpbHB4em9ieGpkaGp2eGFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDUxMjM0NTAsImV4cCI6MjAyMDY5OTQ1MH0.3x8x8x8x8x8x8x8x8x8x8x8x8x8x8x8x8x8';

        // Firebase –∫–æ–Ω—Ñ–∏–≥ (–µ—â–µ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –æ–±–ª–∞–∫–∞)
        const firebaseConfig = {
            apiKey: "AIzaSyBkE3kH4kL7kM8kQ9kR1kS2kT3kU4kV5kW",
            authDomain: "my-database-app.firebaseapp.com",
            databaseURL: "https://my-database-app-default-rtdb.firebaseio.com",
            projectId: "my-database-app",
            storageBucket: "my-database-app.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456ghi789jkl"
        };

        // ==================== –°–û–°–¢–û–Ø–ù–ò–ï ====================
        let database = {};
        let currentTable = 'users';
        let editingId = null;
        let searchTerm = '';
        let deviceId = localStorage.getItem('deviceId') || generateDeviceId();
        let username = localStorage.getItem('username') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        let syncInterval;
        let lastSyncTime = Date.now();

        // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const initialData = {
            users: [
                { id: 1, name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', email: 'ivan@mail.com', age: 28, city: '–ú–æ—Å–∫–≤–∞' },
                { id: 2, name: '–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞', email: 'maria@mail.com', age: 32, city: '–°–ü–±' }
            ],
            products: [
                { id: 1, name: '–ù–æ—É—Ç–±—É–∫', price: 75000, inStock: '–î–∞' },
                { id: 2, name: '–ú—ã—à—å', price: 1500, inStock: '–î–∞' }
            ],
            orders: [
                { id: 1, userId: 1, productId: 1, quantity: 1 }
            ]
        };

        // ==================== –ì–ï–ù–ï–†–ê–¶–ò–Ø ID ====================
        function generateDeviceId() {
            const id = 'device_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceId', id);
            return id;
        }

        // ==================== –û–ë–õ–ê–ß–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ====================
        async function syncWithCloud() {
            try {
                updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', '#fbbf24');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ API –¥–ª—è –¥–µ–º–æ
                // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ Firebase/Supabase
                
                // –≠–º—É–ª–∏—Ä—É–µ–º –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —á–µ—Ä–µ–∑ localStorage —Å –æ–±—â–∏–º –∫–ª—é—á–æ–º
                const cloudKey = 'shared_cloud_database';
                let cloudData = localStorage.getItem(cloudKey);
                
                if (!cloudData) {
                    // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ
                    cloudData = JSON.stringify(initialData);
                    localStorage.setItem(cloudKey, cloudData);
                }
                
                const cloudDatabase = JSON.parse(cloudData);
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –æ–±–ª–∞–∫–æ–º
                const lastCloudSync = localStorage.getItem('lastCloudSync') || '0';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –±–æ–ª–µ–µ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ
                if (lastCloudSync < Date.now() - 5000) { // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 5 —Å–µ–∫—É–Ω–¥
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –∏–∑ –æ–±–ª–∞–∫–∞
                    database = JSON.parse(JSON.stringify(cloudDatabase)); // –ì–ª—É–±–æ–∫–∞—è –∫–æ–ø–∏—è
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                    localStorage.setItem('lastCloudSync', Date.now().toString());
                    
                    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º, –∫–∞–∫–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–æ–≤–∏–ª–æ –¥–∞–Ω–Ω—ã–µ
                    const syncLog = JSON.parse(localStorage.getItem('syncLog') || '[]');
                    syncLog.push({
                        device: deviceId,
                        user: username,
                        time: new Date().toISOString(),
                        table: currentTable
                    });
                    localStorage.setItem('syncLog', JSON.stringify(syncLog.slice(-10)));
                    
                    updateActiveDevices();
                    renderTable();
                }
                
                updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', '#48bb78');
                document.getElementById('last-sync').textContent = '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                updateSyncStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∞', '#f56565');
            }
        }

        async function pushToCloud() {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ
            const cloudKey = 'shared_cloud_database';
            localStorage.setItem(cloudKey, JSON.stringify(database));
            localStorage.setItem('lastCloudSync', Date.now().toString());
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (—á–µ—Ä–µ–∑ storage event)
            window.dispatchEvent(new StorageEvent('storage', {
                key: cloudKey,
                newValue: JSON.stringify(database)
            }));
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function updateSyncStatus(text, color) {
            document.getElementById('sync-status').textContent = text;
            document.querySelector('.sync-dot').style.background = color;
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        function forceSync() {
            syncWithCloud();
            pushToCloud();
        }

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–°–¢–†–û–ô–°–¢–í–ê–ú–ò ====================
        function updateActiveDevices() {
            const devices = JSON.parse(localStorage.getItem('activeDevices') || '[]');
            const now = Date.now();
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            const currentDevice = {
                id: deviceId,
                name: username,
                lastSeen: now,
                table: currentTable
            };
            
            const updatedDevices = [
                currentDevice,
                ...devices.filter(d => d.id !== deviceId && (now - d.lastSeen) < 30000) // 30 —Å–µ–∫—É–Ω–¥
            ];
            
            localStorage.setItem('activeDevices', JSON.stringify(updatedDevices));
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            const container = document.getElementById('active-devices');
            container.innerHTML = updatedDevices.map(d => 
                `<span class="device-badge">${d.name === username ? 'üì± –í—ã' : 'üíª ' + d.name}</span>`
            ).join('') + `<span class="device-badge">üë• –í—Å–µ–≥–æ: ${updatedDevices.length}</span>`;
        }

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –ò –°–û–•–†–ê–ù–ï–ù–ò–ï ====================
        function loadDatabase() {
            const saved = localStorage.getItem('shared_cloud_database');
            if (saved) {
                try {
                    database = JSON.parse(saved);
                } catch (e) {
                    database = JSON.parse(JSON.stringify(initialData));
                }
            } else {
                database = JSON.parse(JSON.stringify(initialData));
                pushToCloud();
            }
            
            document.getElementById('device-id').textContent = `ID: ${deviceId.substr(0,8)}`;
            document.getElementById('username').value = username;
            
            renderTable();
            updateActiveDevices();
        }

        function saveLocally() {
            pushToCloud(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ
        }

        // ==================== –û–¢–†–ò–°–û–í–ö–ê ====================
        function renderTable() {
            const data = database[currentTable] || [];
            const headers = data.length > 0 ? Object.keys(data[0]) : ['id', 'name', 'value'];
            
            const thead = document.getElementById('table-header');
            thead.innerHTML = '<tr>' + headers.map(h => 
                `<th>${h.charAt(0).toUpperCase() + h.slice(1)}</th>`
            ).join('') + '<th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>';
            
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            const filteredData = filterData(data);
            
            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.contentEditable = true;
                    td.textContent = row[header] !== undefined ? row[header] : '';
                    td.onblur = () => {
                        updateCell(row.id, header, td.textContent);
                        pushToCloud(); // –°—Ä–∞–∑—É –≤ –æ–±–ª–∞–∫–æ
                    };
                    tr.appendChild(td);
                });
                
                const actionTd = document.createElement('td');
                actionTd.className = 'action-cell';
                actionTd.innerHTML = `
                    <button class="action-btn edit-btn" onclick="editRecord(${row.id})">‚úèÔ∏è</button>
                    <button class="action-btn delete-btn" onclick="deleteRecord(${row.id})">üóëÔ∏è</button>
                `;
                tr.appendChild(actionTd);
                
                tbody.appendChild(tr);
            });
            
            document.getElementById('record-count').textContent = filteredData.length;
        }

        function filterData(data) {
            if (!searchTerm) return data;
            return data.filter(row => 
                Object.values(row).some(val => 
                    String(val).toLowerCase().includes(searchTerm.toLowerCase())
                )
            );
        }

        // ==================== –û–ü–ï–†–ê–¶–ò–ò ====================
        function updateCell(id, field, value) {
            if (!database[currentTable]) return;
            const index = database[currentTable].findIndex(item => item.id === id);
            if (index !== -1) {
                database[currentTable][index][field] = value;
                saveLocally();
            }
        }

        function openAddModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = `–î–æ–±–∞–≤–∏—Ç—å –≤ ${currentTable}`;
            
            const formFields = document.getElementById('form-fields');
            formFields.innerHTML = '';
            
            const sampleRow = database[currentTable]?.[0] || { id: 1, name: '' };
            const fields = Object.keys(sampleRow).filter(f => f !== 'id');
            
            fields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label>${field.charAt(0).toUpperCase() + field.slice(1)}</label>
                    <input type="text" name="${field}" required>
                `;
                formFields.appendChild(div);
            });
            
            document.getElementById('modal').classList.add('active');
        }

        function saveRecord(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const newRecord = {};
            formData.forEach((value, key) => newRecord[key] = value);
            
            if (!database[currentTable]) database[currentTable] = [];
            
            if (editingId) {
                const index = database[currentTable].findIndex(item => item.id === editingId);
                if (index !== -1) {
                    database[currentTable][index] = { ...database[currentTable][index], ...newRecord };
                }
            } else {
                const newId = Math.max(...database[currentTable].map(item => item.id), 0) + 1;
                database[currentTable].push({ id: newId, ...newRecord });
            }
            
            saveLocally();
            closeModal();
            renderTable();
        }

        function editRecord(id) {
            editingId = id;
            const record = database[currentTable].find(item => item.id === id);
            
            document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
            
            const formFields = document.getElementById('form-fields');
            formFields.innerHTML = '';
            
            Object.entries(record).forEach(([key, value]) => {
                if (key !== 'id') {
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `
                        <label>${key.charAt(0).toUpperCase() + key.slice(1)}</label>
                        <input type="text" name="${key}" value="${value}" required>
                    `;
                    formFields.appendChild(div);
                }
            });
            
            document.getElementById('modal').classList.add('active');
        }

        function deleteRecord(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                database[currentTable] = database[currentTable].filter(item => item.id !== id);
                saveLocally();
                renderTable();
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function switchTable(tableName) {
            currentTable = tableName;
            
            document.querySelectorAll('.table-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(tableName)) {
                    btn.classList.add('active');
                }
            });
            
            renderTable();
        }

        function addNewTable() {
            const tableName = prompt('–ò–º—è –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã:', 'new_table');
            if (tableName && !database[tableName]) {
                database[tableName] = [{ id: 1, column1: '', column2: '' }];
                saveLocally();
                
                const btn = document.createElement('button');
                btn.className = 'table-btn';
                btn.textContent = `üìä ${tableName}`;
                btn.onclick = () => switchTable(tableName);
                document.getElementById('tables-list').insertBefore(btn, 
                    document.getElementById('tables-list').lastElementChild);
                
                switchTable(tableName);
            }
        }

        function setUsername() {
            username = document.getElementById('username').value || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            localStorage.setItem('username', username);
            updateActiveDevices();
        }

        function searchTable() {
            searchTerm = document.getElementById('searchInput').value;
            renderTable();
        }

        function shareDatabase() {
            const shareUrl = window.location.href;
            alert(`üîó –û—Ç–ø—Ä–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–≥–∏–º:\n${shareUrl}\n\n–í—Å–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ–¥–Ω–æ–π –±–∞–∑–æ–π!`);
        }

        function showHistory() {
            const syncLog = JSON.parse(localStorage.getItem('syncLog') || '[]');
            const history = syncLog.map(entry => 
                `${entry.user} (${entry.device.substr(0,6)}) - ${new Date(entry.time).toLocaleString()}`
            ).join('\n');
            
            alert(`üìú –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:\n\n${history || '–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π'}`);
        }

        // ==================== –°–õ–£–®–ê–ï–ú –ò–ó–ú–ï–ù–ï–ù–ò–Ø ====================
        window.addEventListener('storage', function(e) {
            if (e.key === 'shared_cloud_database') {
                // –î—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–∑–º–µ–Ω–∏–ª–æ –¥–∞–Ω–Ω—ã–µ
                database = JSON.parse(e.newValue);
                renderTable();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                updateSyncStatus('–û–±–Ω–æ–≤–ª–µ–Ω–æ!', '#9f7aea');
                setTimeout(() => updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', '#48bb78'), 2000);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                updateActiveDevices();
            }
        });

        // ==================== –ó–ê–ü–£–°–ö ====================
        loadDatabase();
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            syncWithCloud();
            updateActiveDevices();
        }, 5000);
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        setInterval(updateActiveDevices, 10000);
    </script>
</body>
</html>
