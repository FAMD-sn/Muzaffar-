<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Школьная система управления</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border-radius: 10px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--dark);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }

    h1 {
      color: var(--primary);
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      color: var(--gray);
      font-size: 1.1rem;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-bottom: 30px;
    }

    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 25px;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .card-title {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      color: var(--secondary);
      font-size: 1.4rem;
    }

    .card-title i {
      margin-right: 10px;
      font-size: 1.2rem;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--secondary);
    }

    .btn-success {
      background-color: var(--success);
      color: white;
    }

    .btn-success:hover {
      background-color: #3aa8d0;
    }

    .btn-danger {
      background-color: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background-color: #d1146a;
    }

    .btn-warning {
      background-color: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background-color: #e07c0c;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .btn-icon {
      padding: 8px 12px;
      min-width: 40px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .select-class {
      padding: 12px 15px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      font-size: 1rem;
      background-color: white;
      width: 100%;
    }

    /* Таблица учеников */
    .students-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .students-table th {
      background-color: var(--primary);
      color: white;
      text-align: left;
      padding: 15px;
      font-weight: 600;
    }

    .students-table td {
      padding: 15px;
      border-bottom: 1px solid var(--light-gray);
    }

    .students-table tr:hover {
      background-color: rgba(67, 97, 238, 0.05);
    }

    .student-actions {
      display: flex;
      gap: 8px;
    }

    /* Модальные окна */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background-color: white;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transform: translateY(-20px);
      transition: var(--transition);
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.4rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray);
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-close:hover {
      color: var(--danger);
    }

    .modal-body {
      padding: 25px;
    }

    .modal-footer {
      padding: 20px 25px;
      border-top: 1px solid var(--light-gray);
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }

    /* Стили для платежей */
    .payment-method-group {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .payment-method {
      flex: 1;
      text-align: center;
      padding: 15px;
      border: 2px solid var(--light-gray);
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
    }

    .payment-method:hover {
      border-color: var(--primary-light);
    }

    .payment-method.active {
      border-color: var(--primary);
      background-color: rgba(67, 97, 238, 0.05);
    }

    .payment-method i {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .bank-details {
      background-color: rgba(67, 97, 238, 0.05);
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
      display: none;
    }

    .bank-details.active {
      display: block;
    }

    /* Чек платежа */
    .receipt {
      background-color: white;
      border: 2px dashed var(--gray);
      border-radius: 8px;
      padding: 25px;
      max-width: 400px;
      margin: 0 auto;
      font-family: 'Courier New', monospace;
    }

    .receipt-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--light-gray);
      padding-bottom: 15px;
    }

    .receipt-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .receipt-total {
      font-weight: bold;
      font-size: 1.2rem;
      border-top: 2px solid var(--dark);
      padding-top: 10px;
      margin-top: 15px;
    }

    /* Информация об ученике */
    .student-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }

    .info-item {
      background-color: var(--light-gray);
      padding: 15px;
      border-radius: 6px;
    }

    .info-label {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--dark);
    }

    .info-value.positive {
      color: #28a745;
    }

    .info-value.negative {
      color: var(--danger);
    }

    .info-value.warning {
      color: var(--warning);
    }

    /* Прогресс оплаты */
    .payment-progress {
      margin: 20px 0;
    }

    .progress-bar {
      height: 20px;
      background-color: var(--light-gray);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #4cc9f0);
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: var(--gray);
    }

    /* Список платежей */
    .payments-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .payment-item {
      padding: 15px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      margin-bottom: 10px;
      transition: var(--transition);
      cursor: pointer;
    }

    .payment-item:hover {
      background-color: rgba(67, 97, 238, 0.05);
      border-color: var(--primary-light);
    }

    .payment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .payment-amount {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.2rem;
    }

    .payment-date {
      color: var(--gray);
    }

    .payment-details {
      color: var(--gray);
      font-size: 0.9rem;
    }

    /* Сообщения */
    .alert {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-success {
      background-color: rgba(76, 201, 240, 0.15);
      border-left: 4px solid var(--success);
      color: #0a6c7c;
    }

    .alert-info {
      background-color: rgba(67, 97, 238, 0.1);
      border-left: 4px solid var(--primary);
      color: var(--primary);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--light-gray);
    }

    /* Верхняя панель */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .stats {
      display: flex;
      gap: 20px;
    }

    .stat-item {
      background-color: white;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      text-align: center;
      min-width: 120px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--gray);
      margin-top: 5px;
    }

    /* Общая сумма для оплаты */
    .total-amount-info {
      background: linear-gradient(135deg, #4361ee, #3f37c9);
      color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      text-align: center;
    }

    .total-amount-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .total-amount-value {
      font-size: 2rem;
      font-weight: 700;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-graduation-cap"></i> Школьная система управления</h1>
      <p class="subtitle">Учет учеников и управление платежами</p>
    </header>

    <div class="total-amount-info">
      <div class="total-amount-label">Общая сумма к оплате за учебный год</div>
      <div class="total-amount-value">15 000 сомони</div>
    </div>

    <div class="top-bar">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="totalStudents">0</div>
          <div class="stat-label">Учеников</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalPayments">0</div>
          <div class="stat-label">Платежей</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalAmount">0</div>
          <div class="stat-label">Оплачено (сом.)</div>
        </div>
      </div>
      <button class="btn btn-primary" id="addStudentBtn">
        <i class="fas fa-user-plus"></i> Добавить ученика
      </button>
    </div>

    <div class="main-content">
      <div class="card">
        <h2 class="card-title"><i class="fas fa-users"></i> Список учеников</h2>
        
        <div class="form-group">
          <label class="form-label">Фильтр по классу</label>
          <select class="select-class" id="classFilter">
            <option value="">Все классы</option>
            <!-- Опции будут добавлены через JavaScript -->
          </select>
        </div>

        <div class="table-container">
          <table class="students-table">
            <thead>
              <tr>
                <th>ФИО</th>
                <th>Класс</th>
                <th>Оплачено</th>
                <th>Остаток</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="studentsTableBody">
              <!-- Строки будут добавлены через JavaScript -->
            </tbody>
          </table>
          <div id="noStudentsMessage" class="empty-state">
            <i class="fas fa-user-graduate"></i>
            <h3>Нет учеников</h3>
            <p>Добавьте первого ученика, нажав кнопку "Добавить ученика"</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title"><i class="fas fa-chart-line"></i> Информация об ученике</h2>
        <div id="studentDetails">
          <div class="empty-state">
            <i class="fas fa-user-circle"></i>
            <h3>Выберите ученика</h3>
            <p>Нажмите кнопку "Подробнее" рядом с ФИО ученика, чтобы увидеть его данные</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно добавления ученика -->
    <div class="modal-overlay" id="addStudentModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title"><i class="fas fa-user-plus"></i> Добавить ученика</h3>
          <button class="modal-close" id="closeAddStudentModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">ФИО ученика</label>
            <input type="text" class="form-control" id="studentFullName" placeholder="Иванов Иван Иванович">
          </div>
          <div class="form-group">
            <label class="form-label">Дата рождения</label>
            <input type="date" class="form-control" id="studentBirthDate">
          </div>
          <div class="form-group">
            <label class="form-label">Класс</label>
            <select class="form-control" id="studentClassSelect">
              <!-- Опции будут добавлены через JavaScript -->
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Телефон родителя</label>
            <input type="tel" class="form-control" id="studentPhone" placeholder="+992 XXX XX XX XX">
          </div>
          <div class="form-group">
            <label class="form-label">Адрес</label>
            <input type="text" class="form-control" id="studentAddress" placeholder="Город, улица, дом">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="cancelAddStudent">Отмена</button>
          <button class="btn btn-success" id="saveStudentBtn">Сохранить</button>
        </div>
      </div>
    </div>

    <!-- Модальное окно платежей -->
    <div class="modal-overlay" id="paymentModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title"><i class="fas fa-money-check-alt"></i> Добавить платеж</h3>
          <button class="modal-close" id="closePaymentModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <span>Добавление платежа для: <strong id="paymentStudentName">-</strong></span>
          </div>
          
          <div class="form-group">
            <label class="form-label">Сумма платежа (сомони)</label>
            <input type="number" class="form-control" id="paymentAmount" placeholder="Например: 1500">
          </div>
          
          <div class="form-group">
            <label class="form-label">Дата оплаты</label>
            <input type="date" class="form-control" id="paymentDate">
          </div>
          
          <div class="form-group">
            <label class="form-label">Способ оплаты</label>
            <div class="payment-method-group">
              <div class="payment-method" id="cashMethod">
                <i class="fas fa-money-bill-wave"></i>
                <div>Наличными</div>
              </div>
              <div class="payment-method" id="bankMethod">
                <i class="fas fa-university"></i>
                <div>Через банк</div>
              </div>
            </div>
          </div>
          
          <div class="bank-details" id="bankDetails">
            <div class="form-group">
              <label class="form-label">Номер телефона или карты</label>
              <input type="text" class="form-control" id="bankAccount" placeholder="Номер телефона или карты">
            </div>
            <div class="form-group">
              <label class="form-label">Название банка</label>
              <input type="text" class="form-control" id="bankName" placeholder="Например: Амонатбонк">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="cancelPayment">Отмена</button>
          <button class="btn btn-success" id="savePaymentBtn">Сохранить платеж</button>
        </div>
      </div>
    </div>

    <!-- Модальное окно чека -->
    <div class="modal-overlay" id="receiptModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title"><i class="fas fa-receipt"></i> Чек об оплате</h3>
          <button class="modal-close" id="closeReceiptModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="receipt" id="receiptContent">
            <!-- Чек будет сгенерирован через JavaScript -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="printReceiptBtn"><i class="fas fa-print"></i> Печать</button>
          <button class="btn btn-danger" id="closeReceiptBtn">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Инициализация данных
    let students = [];
    let payments = [];
    let selectedStudentId = null;
    let paymentMethod = 'cash'; // 'cash' или 'bank'
    const TOTAL_AMOUNT = 15000; // Общая сумма к оплате

    // Классы для выбора
    const classes = [
      "1А", "1Б", "2А", "2Б", "3А", "3Б", "4А", "4Б", 
      "5А", "5Б", "6А", "6Б", "7А", "7Б", "8А", "8Б", 
      "9А", "9Б", "10А", "10Б", "11А", "11Б"
    ];

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      initClassSelects();
      initEventListeners();
      renderStudentsTable();
      updateStats();
    });

    // Загрузка данных из LocalStorage
    function loadData() {
      const savedStudents = localStorage.getItem('schoolStudents');
      const savedPayments = localStorage.getItem('schoolPayments');
      
      if (savedStudents) {
        students = JSON.parse(savedStudents);
      }
      
      if (savedPayments) {
        payments = JSON.parse(savedPayments);
      }
    }

    // Сохранение данных в LocalStorage
    function saveData() {
      localStorage.setItem('schoolStudents', JSON.stringify(students));
      localStorage.setItem('schoolPayments', JSON.stringify(payments));
    }

    // Инициализация выпадающих списков с классами
    function initClassSelects() {
      const classFilter = document.getElementById('classFilter');
      const studentClassSelect = document.getElementById('studentClassSelect');
      
      // Очищаем списки
      classFilter.innerHTML = '<option value="">Все классы</option>';
      studentClassSelect.innerHTML = '';
      
      // Добавляем опции
      classes.forEach(className => {
        const option1 = document.createElement('option');
        option1.value = className;
        option1.textContent = className;
        classFilter.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = className;
        option2.textContent = className;
        studentClassSelect.appendChild(option2);
      });
      
      // Устанавливаем текущий год как значение по умолчанию для 1 класса
      const currentYear = new Date().getFullYear();
      studentClassSelect.value = '1А';
    }

    // Инициализация обработчиков событий
    function initEventListeners() {
      // Добавление ученика
      document.getElementById('addStudentBtn').addEventListener('click', openAddStudentModal);
      document.getElementById('closeAddStudentModal').addEventListener('click', closeAddStudentModal);
      document.getElementById('cancelAddStudent').addEventListener('click', closeAddStudentModal);
      document.getElementById('saveStudentBtn').addEventListener('click', saveStudent);
      
      // Фильтр по классу
      document.getElementById('classFilter').addEventListener('change', renderStudentsTable);
      
      // Платежи
      document.getElementById('cashMethod').addEventListener('click', () => selectPaymentMethod('cash'));
      document.getElementById('bankMethod').addEventListener('click', () => selectPaymentMethod('bank'));
      document.getElementById('closePaymentModal').addEventListener('click', closePaymentModal);
      document.getElementById('cancelPayment').addEventListener('click', closePaymentModal);
      document.getElementById('savePaymentBtn').addEventListener('click', savePayment);
      
      // Чек
      document.getElementById('closeReceiptModal').addEventListener('click', closeReceiptModal);
      document.getElementById('closeReceiptBtn').addEventListener('click', closeReceiptModal);
      document.getElementById('printReceiptBtn').addEventListener('click', printReceipt);
    }

    // Открытие модального окна добавления ученика
    function openAddStudentModal() {
      document.getElementById('addStudentModal').classList.add('active');
      
      // Устанавливаем текущую дату как дату рождения по умолчанию (7 лет назад)
      const today = new Date();
      const birthDate = new Date(today.getFullYear() - 7, today.getMonth(), today.getDate());
      document.getElementById('studentBirthDate').valueAsDate = birthDate;
    }

    // Закрытие модального окна добавления ученика
    function closeAddStudentModal() {
      document.getElementById('addStudentModal').classList.remove('active');
      clearAddStudentForm();
    }

    // Очистка формы добавления ученика
    function clearAddStudentForm() {
      document.getElementById('studentFullName').value = '';
      document.getElementById('studentBirthDate').value = '';
      document.getElementById('studentClassSelect').value = '1А';
      document.getElementById('studentPhone').value = '';
      document.getElementById('studentAddress').value = '';
    }

    // Сохранение ученика
    function saveStudent() {
      const fullName = document.getElementById('studentFullName').value.trim();
      const birthDate = document.getElementById('studentBirthDate').value;
      const studentClass = document.getElementById('studentClassSelect').value;
      const phone = document.getElementById('studentPhone').value.trim();
      const address = document.getElementById('studentAddress').value.trim();
      
      if (!fullName) {
        alert('Пожалуйста, введите ФИО ученика');
        return;
      }
      
      if (!birthDate) {
        alert('Пожалуйста, укажите дату рождения ученика');
        return;
      }
      
      // Создаем нового ученика
      const newStudent = {
        id: generateId(),
        fullName: fullName,
        birthDate: birthDate,
        class: studentClass,
        phone: phone,
        address: address,
        createdAt: new Date().toISOString()
      };
      
      // Добавляем ученика в массив
      students.push(newStudent);
      
      // Сохраняем данные
      saveData();
      
      // Обновляем интерфейс
      closeAddStudentModal();
      renderStudentsTable();
      updateStats();
      
      // Показываем уведомление
      showAlert(`Ученик ${fullName} успешно добавлен`, 'success');
    }

    // Генерация уникального ID
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Отображение таблицы учеников
    function renderStudentsTable() {
      const tbody = document.getElementById('studentsTableBody');
      const noStudentsMessage = document.getElementById('noStudentsMessage');
      const classFilter = document.getElementById('classFilter').value;
      
      // Фильтрация учеников по классу
      let filteredStudents = students;
      if (classFilter) {
        filteredStudents = students.filter(student => student.class === classFilter);
      }
      
      // Очищаем таблицу
      tbody.innerHTML = '';
      
      if (filteredStudents.length === 0) {
        noStudentsMessage.style.display = 'block';
        return;
      }
      
      noStudentsMessage.style.display = 'none';
      
      // Добавляем строки для каждого ученика
      filteredStudents.forEach(student => {
        // Получаем платежи для этого ученика
        const studentPayments = payments.filter(p => p.studentId === student.id);
        const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
        const remainingAmount = TOTAL_AMOUNT - totalPaid;
        
        // Определяем цвет остатка
        let remainingClass = '';
        if (remainingAmount === 0) {
          remainingClass = 'positive';
        } else if (remainingAmount > 0 && remainingAmount < TOTAL_AMOUNT) {
          remainingClass = 'warning';
        } else if (remainingAmount > 0) {
          remainingClass = 'negative';
        }
        
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${student.fullName}</td>
          <td>${student.class}</td>
          <td><strong>${totalPaid}</strong> сом.</td>
          <td><strong class="${remainingClass}">${remainingAmount}</strong> сом.</td>
          <td>
            <div class="student-actions">
              <button class="btn btn-primary btn-small btn-icon" onclick="showStudentDetails('${student.id}')" title="Подробнее">
                <i class="fas fa-info-circle"></i>
              </button>
              <button class="btn btn-success btn-small btn-icon" onclick="openPaymentModal('${student.id}')" title="Добавить платеж">
                <i class="fas fa-money-bill-wave"></i>
              </button>
              <button class="btn btn-danger btn-small btn-icon" onclick="deleteStudent('${student.id}')" title="Удалить">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Показать детали ученика
    function showStudentDetails(studentId) {
      const student = students.find(s => s.id === studentId);
      const studentDetails = document.getElementById('studentDetails');
      
      if (!student) {
        studentDetails.innerHTML = '<div class="alert alert-danger">Ученик не найден</div>';
        return;
      }
      
      // Получаем платежи для этого ученика
      const studentPayments = payments.filter(p => p.studentId === studentId);
      const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
      const remainingAmount = TOTAL_AMOUNT - totalPaid;
      const paymentPercentage = Math.round((totalPaid / TOTAL_AMOUNT) * 100);
      
      // Определяем цвет остатка
      let remainingClass = '';
      if (remainingAmount === 0) {
        remainingClass = 'positive';
      } else if (remainingAmount > 0 && remainingAmount < TOTAL_AMOUNT) {
        remainingClass = 'warning';
      } else if (remainingAmount > 0) {
        remainingClass = 'negative';
      }
      
      // Форматируем дату рождения
      const birthDate = new Date(student.birthDate);
      const formattedBirthDate = birthDate.toLocaleDateString('ru-RU');
      
      let paymentsHtml = '';
      if (studentPayments.length > 0) {
        studentPayments.forEach(payment => {
          const paymentDate = new Date(payment.date);
          const formattedDate = paymentDate.toLocaleDateString('ru-RU');
          
          paymentsHtml += `
            <div class="payment-item" onclick="showReceipt('${payment.id}')">
              <div class="payment-header">
                <div class="payment-amount">${payment.amount} сом.</div>
                <div class="payment-date">${formattedDate}</div>
              </div>
              <div class="payment-details">
                <i class="fas fa-${payment.method === 'cash' ? 'money-bill-wave' : 'university'}"></i>
                ${payment.method === 'cash' ? 'Наличными' : `Через банк (${payment.bankName})`}
              </div>
            </div>
          `;
        });
      } else {
        paymentsHtml = '<div class="empty-state"><i class="fas fa-money-bill"></i><p>Нет платежей</p></div>';
      }
      
      studentDetails.innerHTML = `
        <div class="student-info">
          <div class="info-item">
            <div class="info-label">ФИО</div>
            <div class="info-value">${student.fullName}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Класс</div>
            <div class="info-value">${student.class}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Дата рождения</div>
            <div class="info-value">${formattedBirthDate}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Телефон</div>
            <div class="info-value">${student.phone || 'Не указан'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Адрес</div>
            <div class="info-value">${student.address || 'Не указан'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Оплачено</div>
            <div class="info-value">${totalPaid} сом.</div>
          </div>
          <div class="info-item">
            <div class="info-label">Общая сумма</div>
            <div class="info-value">${TOTAL_AMOUNT} сом.</div>
          </div>
          <div class="info-item">
            <div class="info-label">Остаток</div>
            <div class="info-value ${remainingClass}">${remainingAmount} сом.</div>
          </div>
          <div class="info-item">
            <div class="info-label">Кол-во платежей</div>
            <div class="info-value">${studentPayments.length}</div>
          </div>
        </div>
        
        <div class="payment-progress">
          <div class="progress-info">
            <span>Прогресс оплаты</span>
            <span>${paymentPercentage}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${paymentPercentage}%"></div>
          </div>
          <div class="progress-info">
            <span>Оплачено: ${totalPaid} сом.</span>
            <span>Осталось: ${remainingAmount} сом.</span>
          </div>
        </div>
        
        <h3 class="card-title"><i class="fas fa-history"></i> История платежей</h3>
        <div class="payments-list">
          ${paymentsHtml}
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
          <button class="btn btn-success" onclick="openPaymentModal('${student.id}')">
            <i class="fas fa-plus-circle"></i> Добавить платеж
          </button>
        </div>
      `;
      
      selectedStudentId = studentId;
    }

    // Открытие модального окна платежей
    function openPaymentModal(studentId) {
      const student = students.find(s => s.id === studentId);
      
      if (!student) {
        alert('Ученик не найден');
        return;
      }
      
      // Получаем информацию о текущих платежах
      const studentPayments = payments.filter(p => p.studentId === studentId);
      const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
      const remainingAmount = TOTAL_AMOUNT - totalPaid;
      
      selectedStudentId = studentId;
      document.getElementById('paymentStudentName').textContent = student.fullName;
      
      // Показываем информацию об остатке
      const alertElement = document.querySelector('#paymentModal .alert');
      alertElement.innerHTML = `
        <i class="fas fa-info-circle"></i>
        <span>
          Добавление платежа для: <strong>${student.fullName}</strong><br>
          <small>Остаток к оплате: <strong>${remainingAmount} сом.</strong> из ${TOTAL_AMOUNT} сом.</small>
        </span>
      `;
      
      // Устанавливаем текущую дату как дату оплаты по умолчанию
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];
      document.getElementById('paymentDate').value = formattedDate;
      
      // Сбрасываем форму
      document.getElementById('paymentAmount').value = '';
      selectPaymentMethod('cash');
      
      // Открываем модальное окно
      document.getElementById('paymentModal').classList.add('active');
    }

    // Закрытие модального окна платежей
    function closePaymentModal() {
      document.getElementById('paymentModal').classList.remove('active');
    }

    // Выбор способа оплаты
    function selectPaymentMethod(method) {
      paymentMethod = method;
      
      // Обновляем визуальное выделение
      document.getElementById('cashMethod').classList.toggle('active', method === 'cash');
      document.getElementById('bankMethod').classList.toggle('active', method === 'bank');
      
      // Показываем/скрываем детали банковского перевода
      document.getElementById('bankDetails').classList.toggle('active', method === 'bank');
      
      // Очищаем поля банковских реквизитов при переключении на наличные
      if (method === 'cash') {
        document.getElementById('bankAccount').value = '';
        document.getElementById('bankName').value = '';
      }
    }

    // Сохранение платежа
    function savePayment() {
      const amount = parseFloat(document.getElementById('paymentAmount').value);
      const date = document.getElementById('paymentDate').value;
      
      if (!amount || amount <= 0) {
        alert('Пожалуйста, введите корректную сумму платежа');
        return;
      }
      
      if (!date) {
        alert('Пожалуйста, укажите дату оплаты');
        return;
      }
      
      if (!selectedStudentId) {
        alert('Ошибка: ученик не выбран');
        return;
      }
      
      // Проверяем, не превышает ли платеж остаток
      const studentPayments = payments.filter(p => p.studentId === selectedStudentId);
      const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
      const remainingAmount = TOTAL_AMOUNT - totalPaid;
      
      if (amount > remainingAmount) {
        if (!confirm(`Сумма платежа (${amount} сом.) превышает остаток к оплате (${remainingAmount} сом.). Продолжить?`)) {
          return;
        }
      }
      
      let bankAccount = '';
      let bankName = '';
      
      if (paymentMethod === 'bank') {
        bankAccount = document.getElementById('bankAccount').value.trim();
        bankName = document.getElementById('bankName').value.trim();
        
        if (!bankAccount) {
          alert('Пожалуйста, введите номер телефона или карты');
          return;
        }
        
        if (!bankName) {
          alert('Пожалуйста, введите название банка');
          return;
        }
      }
      
      // Создаем новый платеж
      const newPayment = {
        id: generateId(),
        studentId: selectedStudentId,
        amount: amount,
        date: date,
        method: paymentMethod,
        bankAccount: bankAccount,
        bankName: bankName,
        createdAt: new Date().toISOString()
      };
      
      // Добавляем платеж в массив
      payments.push(newPayment);
      
      // Сохраняем данные
      saveData();
      
      // Обновляем интерфейс
      closePaymentModal();
      showStudentDetails(selectedStudentId);
      renderStudentsTable();
      updateStats();
      
      // Показываем уведомление
      showAlert(`Платеж на сумму ${amount} сомони успешно добавлен`, 'success');
      
      // Показываем чек
      showReceipt(newPayment.id);
    }

    // Показать чек
    function showReceipt(paymentId) {
      const payment = payments.find(p => p.id === paymentId);
      
      if (!payment) {
        alert('Платеж не найден');
        return;
      }
      
      const student = students.find(s => s.id === payment.studentId);
      const paymentDate = new Date(payment.date);
      const formattedDate = paymentDate.toLocaleDateString('ru-RU');
      const formattedTime = paymentDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
      
      // Получаем информацию о платежах ученика
      const studentPayments = payments.filter(p => p.studentId === payment.studentId);
      const totalPaid = studentPayments.reduce((sum, p) => sum + p.amount, 0);
      const remainingAmount = TOTAL_AMOUNT - totalPaid;
      
      let paymentDetails = '';
      if (payment.method === 'cash') {
        paymentDetails = 'Оплата наличными';
      } else {
        paymentDetails = `
          Банк: ${payment.bankName}<br>
          Счет: ${payment.bankAccount}
        `;
      }
      
      const receiptContent = document.getElementById('receiptContent');
      receiptContent.innerHTML = `
        <div class="receipt-header">
          <h3>Школьная система управления</h3>
          <p>Чек об оплате</p>
        </div>
        
        <div class="receipt-item">
          <div>Дата:</div>
          <div>${formattedDate}</div>
        </div>
        
        <div class="receipt-item">
          <div>Время:</div>
          <div>${formattedTime}</div>
        </div>
        
        <div class="receipt-item">
          <div>Номер чека:</div>
          <div>${payment.id.substring(0, 8)}</div>
        </div>
        
        <hr>
        
        <div class="receipt-item">
          <div>Ученик:</div>
          <div>${student ? student.fullName : 'Неизвестно'}</div>
        </div>
        
        <div class="receipt-item">
          <div>Класс:</div>
          <div>${student ? student.class : 'Неизвестно'}</div>
        </div>
        
        <hr>
        
        <div class="receipt-item">
          <div>Сумма платежа:</div>
          <div>${payment.amount} сомони</div>
        </div>
        
        <div class="receipt-item">
          <div>Способ оплаты:</div>
          <div>${payment.method === 'cash' ? 'Наличными' : 'Банковский перевод'}</div>
        </div>
        
        <div style="margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
          ${paymentDetails}
        </div>
        
        <div class="receipt-item">
          <div>Всего оплачено:</div>
          <div>${totalPaid} сомони</div>
        </div>
        
        <div class="receipt-item">
          <div>Остаток к оплате:</div>
          <div>${remainingAmount} сомони</div>
        </div>
        
        <hr>
        
        <div class="receipt-item receipt-total">
          <div>ИТОГО К ОПЛАТЕ:</div>
          <div>${TOTAL_AMOUNT} сомони</div>
        </div>
        
        <hr>
        
        <div style="text-align: center; margin-top: 20px; color: #6c757d; font-size: 0.9rem;">
          <p>Спасибо за оплату!</p>
          <p>Чек сгенерирован автоматически</p>
        </div>
      `;
      
      // Открываем модальное окно с чеком
      document.getElementById('receiptModal').classList.add('active');
    }

    // Закрытие модального окна с чеком
    function closeReceiptModal() {
      document.getElementById('receiptModal').classList.remove('active');
    }

    // Печать чека
    function printReceipt() {
      const printContent = document.getElementById('receiptContent').innerHTML;
      const originalContent = document.body.innerHTML;
      
      document.body.innerHTML = printContent;
      window.print();
      document.body.innerHTML = originalContent;
      
      // Восстанавливаем обработчики событий
      initEventListeners();
      renderStudentsTable();
      
      // Показываем чек снова после печати
      document.getElementById('receiptModal').classList.add('active');
    }

    // Удаление ученика
    function deleteStudent(studentId) {
      if (!confirm('Вы уверены, что хотите удалить этого ученика? Все его платежи также будут удалены.')) {
        return;
      }
      
      // Удаляем ученика
      students = students.filter(s => s.id !== studentId);
      
      // Удаляем платежи ученика
      payments = payments.filter(p => p.studentId !== studentId);
      
      // Сохраняем данные
      saveData();
      
      // Обновляем интерфейс
      renderStudentsTable();
      updateStats();
      
      // Очищаем детали ученика, если он был выбран
      if (selectedStudentId === studentId) {
        document.getElementById('studentDetails').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-user-circle"></i>
            <h3>Выберите ученика</h3>
            <p>Нажмите кнопку "Подробнее" рядом с ФИО ученика, чтобы увидеть его данные</p>
          </div>
        `;
        selectedStudentId = null;
      }
      
      // Показываем уведомление
      showAlert('Ученик успешно удален', 'success');
    }

    // Обновление статистики
    function updateStats() {
      document.getElementById('totalStudents').textContent = students.length;
      document.getElementById('totalPayments').textContent = payments.length;
      
      const totalAmount = payments.reduce((sum, payment) => sum + payment.amount, 0);
      document.getElementById('totalAmount').textContent = totalAmount;
    }

    // Показать уведомление
    function showAlert(message, type = 'info') {
      // Создаем элемент уведомления
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      
      // Добавляем уведомление в начало страницы
      const container = document.querySelector('.container');
      container.insertBefore(alert, container.firstChild);
      
      // Удаляем уведомление через 5 секунд
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }
  </script>
</body>
</html>
